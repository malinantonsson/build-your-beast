var downloadButton=document.getElementById("print"),canvasWrapper=document.getElementsByClassName("byb-canvas")[0],canvas,beastCanvas,DOMURL=window.URL||window.webkitURL||window,beast={colour:{id:"pink",x:0,y:0,"short":"h",el:"trick-or-treat"},crown:{id:"",x:0,y:0,"short":"c",el:"byb-canvas-crown"},eyes:{id:"",x:87,y:210,"short":"e",el:"byb-canvas-eyes"},nose:{id:"",x:87,y:320,"short":"n",el:"byb-canvas-nose"},mouth:{id:"",x:87,y:430,"short":"m",el:"byb-canvas-mouth"}},addItem=function(e,a){var n=new Image,t=new Blob([e.data],{type:"image/svg+xml"}),r=DOMURL.createObjectURL(t);n.onload=function(){beastCanvas.drawImage(n,e.x,e.y),DOMURL.revokeObjectURL(r)},n.src=r},addBeastColour=function(e){switch(e){case"pink":hex="#ed6171";break;case"green":hex="#02583f";break;case"red":hex="#a7361d"}return'<svg xmlns="http://www.w3.org/2000/svg" width="480" height="608" x="0px" y="0px" viewBox="0 0 479.5 608" enable-background="new 0 0 479.5 608" xml:space="preserve"><g id="background"><rect x="-270" y="-51" display="inline" width="100%" height="100%"/></g><g id="face_colour_1"><path fill="'+hex+'" d="M393,456.4c0,84.3-68.3,152.6-152.6,152.6h-0.7C155.3,609,87,540.7,87,456.4V232.6C87,148.3,155.3,80,239.6,80h0.7C324.7,80,393,148.3,393,232.6V456.4z"/></g></svg>'},downloadImageLink=function(e){return e.replace("image/png","image/octet-stream")},getImgData=function(){var e=canvas.toDataURL();return downloadImageLink(e)},addSelectedItems=function(){for(var e in beast){var a,n=beast[e].id;a="colour"===e?addBeastColour(beast.colour.id):svgData[e][n];var t={data:a,x:beast[e].x,y:beast[e].y};addItem(t)}},createCanvas=function(){canvas=document.createElement("canvas"),canvas.id="byb-canvas__canvas",canvas.width=480,canvas.height=608,beastCanvas=canvas.getContext("2d"),beastCanvas.clearRect(0,0,canvas.width,canvas.height),beastCanvas.fillStyle="#000",beastCanvas.fillRect(0,0,canvas.width,canvas.height),beastCanvas.fill(),canvasWrapper.appendChild(canvas)},clearCanvas=function(){beastCanvas&&(beastCanvas.clearRect(0,0,canvas.width,canvas.height),beastCanvas.fillStyle="#000",beastCanvas.fillRect(0,0,canvas.width,canvas.height),beastCanvas.fill())},closeImageOverlay=function(e,a){e.addEventListener("click",function(e){a.style.display="none"})},initDownload=function(){var e=document.querySelector(".download-image-wrapper"),a=document.querySelector(".download-image-content"),n=document.querySelector(".js-download-image__image");downloadButton.addEventListener("click",function(t){var r=getImgData();if(window.Modernizr&&window.Modernizr.touch){t.preventDefault(),n.src=r,a.appendChild(n),e.style.display="block";var o=document.querySelector(".js-close-image-overlay");closeImageOverlay(o,e)}else downloadButton.href=r;return!1})};window.Modernizr&&window.Modernizr.canvas?downloadButton&&(initDownload(),createCanvas()):console.log("hide canvas");var svgData,colourClass="active-colour-",errorSection,body=document.getElementsByTagName("body")[0],errorClass="has-error",errors=!1,outerWrapper=document.querySelector(".byb-outside-wrapper"),introWrapper=document.querySelector(".intro-lightning"),introClass="is-intro",hideIntroClass="intro-end",removeIntroClass="intro-hidden",introIsFinished=!1;setTimeout(function(){introIsFinished||(introIsFinished=!0)},4500);var finishIntro=function(){introWrapper.classList.add(hideIntroClass),setTimeout(function(){outerWrapper.classList.remove(introClass),introWrapper.classList.add(removeIntroClass),outerWrapper.style.display="block"},1e3)},getParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=a.exec(location.search);return null===n?!1:decodeURIComponent(n[1].replace(/\+/g," "))},handleData=function(e,a){if("colour"===e)body.className=colourClass+a.id;else{var n=document.getElementsByClassName(a.el)[0];n.innerHTML=svgData[e][a.id]}},handleError=function(){body.className=errorClass},getData=function(){var e=new XMLHttpRequest;e.open("GET","/data/beast-data.json",!0),e.onload=function(){if(this.status>=200&&this.status<400){if(svgData=JSON.parse(this.response),introIsFinished)finishIntro();else var e=setInterval(function(){introIsFinished&&(clearInterval(e),finishIntro())},500);for(var a in beast){var n=beast[a],t=getParameterByName(n["short"]);if(!t){errors=!0,handleError();break}n.id=t,handleData(a,n)}errors||addSelectedItems()}else console.log("returned error"),handleError()},e.onerror=function(){console.log("connection error"),handleError()},e.send()},init=function(){getData()};init();